--=======================================================================================================================================
/*Category 1 Funnel & Behavioral Analytics:
Comprehensive evaluation of user progression through funnel stages to identify conversion rates, drop-offs, and traffic source impact. */
--=======================================================================================================================================


--===================
--Funnel event- based
--===================

--Nr. events per each stage

SELECT 
    event_type,
    COUNT(event_id) AS NrEvents
FROM events
GROUP BY event_type
ORDER BY NrEvents DESC

-- Funnel conversion from 'Add to cart' to 'purchase' 

WITH funnel AS
(SELECT
    SUM(CASE WHEN event_type = 'add_to_cart' THEN 1 ELSE 0 END) AS [Add to cart events],
    SUM(CASE WHEN event_type = 'purchase' THEN 1 ELSE 0 END) AS [Purchase Events]
FROM [events ]
)
SELECT 
    *,
   ROUND(([Purchase Events] * 1.0/ [Add to cart events]) * 100,2) AS Conversion_rate_percentage
FROM funnel

-- Funnel conversion by traffic source

SELECT 
    traffic_source,
    SUM(CASE WHEN event_type = 'add_to_cart' THEN 1 ELSE 0 END) AS AddToCartEvents,
    SUM(CASE WHEN event_type = 'purchase' THEN 1 ELSE 0 END) AS PurchaseEvents,
    ROUND( (SUM(CASE WHEN event_type = 'purchase' THEN 1 ELSE 0 END) * 1.0 /
           SUM(CASE WHEN event_type = 'add_to_cart' THEN 1 ELSE 0 END) * 100),2) AS ConversionRate_Percent
FROM events
GROUP BY traffic_source
ORDER BY ConversionRate_Percent DESC


--Funnel conversion by device_type

SELECT 
    device_type,
    SUM(CASE WHEN event_type = 'add_to_cart' THEN 1 ELSE 0 END) AS AddToCartEvents,
    SUM(CASE WHEN event_type = 'purchase' THEN 1 ELSE 0 END) AS PurchaseEvents,
    ROUND((SUM(CASE WHEN event_type = 'purchase' THEN 1 ELSE 0 END) * 1.0 /
           NULLIF(SUM(CASE WHEN event_type = 'add_to_cart' THEN 1 ELSE 0 END),0)) * 100,2) AS ConversionRate_Percent
FROM events
GROUP BY device_type
ORDER BY ConversionRate_Percent DESC;

/*
There is a limitation with a event-based funnel because:
- One user can inflate add_to_cart events
- Conversion rates can exceed reality

- User-based funnel is often a preferred approach, that's why we also will perform it. */


--=======================
--Funnel users-based
--=======================

-- Funnel conversion from 'Add to cart' to 'purchase'

WITH stage_users AS (
    SELECT DISTINCT
        customer_id,
        event_type
    FROM events
    WHERE event_type IN ('add_to_cart', 'purchase')
)
SELECT
    COUNT(DISTINCT CASE WHEN event_type = 'add_to_cart' THEN customer_id END) AS AddToCartUsers,
    COUNT(DISTINCT CASE WHEN event_type = 'purchase' THEN customer_id END) AS PurchaseUsers,
    ROUND(
        COUNT(DISTINCT CASE WHEN event_type = 'purchase' THEN customer_id END) * 1.0 /
        NULLIF(COUNT(DISTINCT CASE WHEN event_type = 'add_to_cart' THEN customer_id END), 0)
        * 100, 2
    ) AS ConversionRate_Percent
FROM stage_users;

/* As we can see, seemingly, there was a inflate add to cart events.
- Conversion rate based on events: 36.3 %
- Conversion rate based on users: 70 % */


--Nr. Customers per each stage

SELECT 
    event_type,
    COUNT(customer_id) AS NrCustomer
FROM events
GROUP BY event_type
ORDER BY NrCustomer DESC


SELECT 
    event_type,
    COUNT(event_id) AS NrEvents
FROM events
GROUP BY event_type
ORDER BY NrEvents DESC


-- Funnel conversion by traffic source

WITH stage_users AS (
    SELECT DISTINCT
        customer_id,
        traffic_source,
        event_type
    FROM events
    WHERE event_type IN ('add_to_cart', 'purchase')
)
SELECT
    traffic_source,
    COUNT(DISTINCT CASE WHEN event_type = 'add_to_cart' THEN customer_id END) AS AddToCartUsers,
    COUNT(DISTINCT CASE WHEN event_type = 'purchase' THEN customer_id END) AS PurchaseUsers,
    ROUND(
        COUNT(DISTINCT CASE WHEN event_type = 'purchase' THEN customer_id END) * 1.0 /
        COUNT(DISTINCT CASE WHEN event_type = 'add_to_cart' THEN customer_id END)
        * 100, 2
    ) AS ConversionRate_Percent
FROM stage_users
GROUP BY traffic_source
ORDER BY ConversionRate_Percent DESC


--Funnel conversion by device_type

WITH stage_users AS (
    SELECT DISTINCT
        customer_id,
        device_type,
        event_type
    FROM events
    WHERE event_type IN ('add_to_cart', 'purchase')
)
SELECT
    device_type,
    COUNT(DISTINCT CASE WHEN event_type = 'add_to_cart' THEN customer_id END) AS AddToCartUsers,
    COUNT(DISTINCT CASE WHEN event_type = 'purchase' THEN customer_id END) AS PurchaseUsers,
    ROUND(
        COUNT(DISTINCT CASE WHEN event_type = 'purchase' THEN customer_id END) * 1.0 /
        NULLIF(COUNT(DISTINCT CASE WHEN event_type = 'add_to_cart' THEN customer_id END), 0)
        * 100, 2
    ) AS ConversionRate_Percent
FROM stage_users
GROUP BY device_type
ORDER BY ConversionRate_Percent DESC;

/* Insights:

Funnel conversion rate from 'Add to cart' to 'purchase' is 36% based on event, whereas is 70% based on users

Funnel conversion by traffic source based on users has a higher conversion rate,
3 top traffic source mantain equals, however, organic is better-posicioned and with 8% conversion rate more.

While Funnel conversion by device type based on event shows 36% for every device, with tablet as a higher performed.
There are a total different results for the funnel based on users, exhibiting mobile as higher performer, desktop and then tablet. 

Segments with lower user-based conversion rates implicitly represent higher abandonment after the add-to-cart stage*/

